{"componentChunkName":"component---src-components-tutorials-js","path":"/tutorials/leaflet-loading-screens/","result":{"data":{"markdownRemark":{"html":"<h2>Contents</h2>\n<ol>\n<li><a href=\"#about\">Why would I need this?</a></li>\n<li>\n<p><a href=\"#work\">How does this app work?</a></p>\n<ul>\n<li><a href=\"#work-new-app\">Creating the structure of the shiny app</a></li>\n<li><a href=\"#work-ui-html\">Writing the HTML markup for the loading UI</a></li>\n<li><a href=\"#work-ui-css\">Styling the loading UI</a></li>\n<li><a href=\"#work-ui-js\">Writing javascript to control the loading UI</a></li>\n</ul>\n</li>\n<li><a href=\"#know\">What do I need to know before I integrate this into my app?</a></li>\n<li><a href=\"#run\">How do I run the example?</a></li>\n</ol>\n<!-- endexcerpt -->\n<span id=\"about\" />\n<h2>Why would I need this?</h2>\n<p>The leaflet package in R is great package for creating interactive maps in shiny. However, if you are using larger datasets or running a lot of server-side jobs, it may take some time for the leaflet map to render and update. This may result in a poor user experience as the user will have to wait for some time until they can view the data or perform additional actions. It is possible to alleviate some of the waiting by rewriting reactive events to observe events, but sometimes that is not enough. Displaying progress indicators can improve the user experience by reassuring the user when something is happening and how long it might last. </p>\n<p>A quick side note: the 99% Invisible episode <a href=\"https://99percentinvisible.org/episode/wait-wait-tell-me/\">Wait Wait...Tell me!</a> provides a fascinating overview on the history of waiting and user interfaces.</p>\n<p>There are some fantastic R packages for creating wait messages in shiny (e.g., <a href=\"https://github.com/JohnCoene/waiter\">waitr</a>, <a href=\"https://github.com/JohnCoene/waiter\">shinycustomloader</a>, etc.), but it is a bit tricky to add to work with leaflet. Instead, with a little bit of html, css, ans javascript, we can create our own. This tutorial provides instructions for creating a loading screen for leaflet outputs. Specifically, the example application will demonstrate how to -</p>\n<ol>\n<li>Display a loading screen during the intitial rendering of a leaflet map, and to</li>\n<li>Show the loading screen when a button is clicked and to remain visible until server-side processing is complete</li>\n</ol>\n<p>The app was originally written for this R community post: <a href=\"https://community.rstudio.com/t/show-leaflet-spinner-when-rendering-slow-leaflet-map-in-shiny/57896\">Show leaflet spinner when rendering slow leaflet map in shiny</a>.</p>\n<blockquote>\n<p>This tutorial focuses on javascript. Some experience will definitely help, but it is not required. I've tried to keep concepts simple and reference outside sources where possible. If you have suggestions for improvement or notice any errors, feel free to open a new <a href=\"https://github.com/davidruvolo51/shinytutorials/issues\">issue</a>.</p>\n</blockquote>\n<span id=\"work\" />\n<h2>How does this app work?</h2>\n<p>To get the app up and running, we need to complete a few things. In this section, I will cover the following items.</p>\n<ol>\n<li>Creating the structure of the shiny app</li>\n<li>Writing the HTML markup for the loading UI</li>\n<li>Styling the loading UI</li>\n<li>Writing javascript to control the loading UI </li>\n</ol>\n<span id=\"work-new-app\" />\n<h3>Creating the structure of the shiny app</h3>\n<p>Let's start off by setting up our project and creating the files. Create a new directory and an R project. Open the R project and then create the following.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token comment\"># in the console</span>\nfile.create<span class=\"token punctuation\">(</span><span class=\"token string\">\"app.R\"</span><span class=\"token punctuation\">)</span>\nfile.create<span class=\"token punctuation\">(</span><span class=\"token string\">\"leaflet_loader.R\"</span><span class=\"token punctuation\">)</span>\ndir.create<span class=\"token punctuation\">(</span><span class=\"token string\">\"www\"</span><span class=\"token punctuation\">)</span>\nfile.create<span class=\"token punctuation\">(</span><span class=\"token string\">\"www/styles.css\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>In this example, I'm using the single <code>app.R</code> approach. I created a separate R file for the loading UI component and save all corresponding styles in a css file (located in the <code>www/</code> directory).</p>\n<p>I'm using the <a href=\"https://shiny.rstudio.com/articles/html-tags.html\">tags</a> approach for the UI. <code>tags$link</code> is used to load the stylesheet. I'm wrapping everything in the <code>main</code> element. In the original post, the user wanted to show the loading UI when a button is clicked. I added an button and assigned the appropriate classes to register the element with shiny. I left some blank space for now. This space will be used for the leaflet loader, which will be discussed in a little bit.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token comment\"># ui</span>\nui <span class=\"token operator\">&lt;-</span> tagList<span class=\"token punctuation\">(</span>\n    tags<span class=\"token operator\">$</span>head<span class=\"token punctuation\">(</span>\n        tags<span class=\"token operator\">$</span>link<span class=\"token punctuation\">(</span>\n            rel <span class=\"token operator\">=</span> <span class=\"token string\">\"stylesheet\"</span><span class=\"token punctuation\">,</span>\n            href <span class=\"token operator\">=</span> <span class=\"token string\">\"styles.css\"</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n    tags<span class=\"token operator\">$</span>main<span class=\"token punctuation\">(</span>\n        tags<span class=\"token operator\">$</span>h2<span class=\"token punctuation\">(</span><span class=\"token string\">\"Map Output\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">$</span>button<span class=\"token punctuation\">(</span>\n            id <span class=\"token operator\">=</span> <span class=\"token string\">\"plotbutton\"</span><span class=\"token punctuation\">,</span>\n            class <span class=\"token operator\">=</span> <span class=\"token string\">\"action-button shiny-bound-input\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"Add Markers\"</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token comment\"># loading ui</span>\n        <span class=\"token ellipsis\">...</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>In the server, I created a basic leaflet map using the example provided in the R leaflet's <a href=\"https://github.com/rstudio/leaflet/blob/master/README.md\">README</a> (accessed on 2020-04-02). Using the <a href=\"https://community.rstudio.com/t/show-leaflet-spinner-when-rendering-slow-leaflet-map-in-shiny/57896/10\">example</a> provided in the R community post, I added an event that adds random markers around a coordinate set when a button is clicked.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token comment\"># server</span>\nserver <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> output<span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\"># render map</span>\n    output<span class=\"token operator\">$</span>map <span class=\"token operator\">&lt;-</span> renderLeaflet<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token comment\"># simulate building</span>\n        <span class=\"token comment\"># build map</span>\n        leaflet<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span>\n            addTiles<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span>\n            setView<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">93.65</span><span class=\"token punctuation\">,</span> <span class=\"token number\">42.0285</span><span class=\"token punctuation\">,</span> zoom <span class=\"token operator\">=</span> <span class=\"token number\">17</span><span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span>\n            addPopups<span class=\"token punctuation\">(</span>\n                lng <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">93.65</span><span class=\"token punctuation\">,</span>\n                lat <span class=\"token operator\">=</span> <span class=\"token number\">42.0285</span><span class=\"token punctuation\">,</span>\n                popup <span class=\"token operator\">=</span> <span class=\"token string\">\"Here is the &lt;b>Department of Statistics&lt;/b>, ISU\"</span>\n            <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># add points on render</span>\n    observeEvent<span class=\"token punctuation\">(</span>input<span class=\"token operator\">$</span>plotbutton<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        dlat <span class=\"token operator\">&lt;-</span> <span class=\"token number\">1</span> <span class=\"token operator\">/</span> <span class=\"token number\">111000</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span> <span class=\"token comment\"># degrees per metre</span>\n        n <span class=\"token operator\">&lt;-</span> <span class=\"token number\">100</span>\n        leafletProxy<span class=\"token punctuation\">(</span><span class=\"token string\">\"map\"</span><span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span>\n            addMarkers<span class=\"token punctuation\">(</span>\n                lng <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">93.65</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>runif<span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> dlat <span class=\"token operator\">*</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n                lat <span class=\"token operator\">=</span> <span class=\"token number\">42.0285</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>runif<span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> dlat\n            <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now, let's focus on the loading UI.</p>\n<span id=\"work-ui-html\" />\n<h3>Writing the HTML markup for the loading UI</h3>\n<p>In the file <code>leaflet_loader.R</code>, we will define a function that creates a loading UI. This function will take the leafletOutput and wrap it in a container. The container will also have a secondary child element that contains the markup for the loading message. In this example, the function will display a text message or display loading dots. (If you have your own icon, spinner, etc., you can substitute it here.). The returned html will look like this.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>loading-container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>loading-ui<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token comment\">&lt;!--- loader ---></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>map<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token comment\">&lt;!--- leaflet output ---></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>The showing of the loading element works by adding and removing a css class <code>.visually-hidden</code>. This class contains a few properties that hides the element visually by manipulating the width, height, overflow, and a few other properties of the element it is added to. This is likely better approach (performance wise) than using <code>display: none;</code> as the element isn't continuously added and removed from the document (this will be discussed in the next section).</p>\n<p>Let's start with a secondary function that generates the loading message. This function will return the markup for the loading ui element based on whether or not the loader is a text message. To demonstrate a custom loader, I'm creating a series of dots that will be animated using css which will make them \"blink\".</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token comment\"># loading screen functional component: child element</span>\nloading_elem <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> text <span class=\"token operator\">=</span> <span class=\"token keyword\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    stopifnot<span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>is.null<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># generate element with dots</span>\n    el <span class=\"token operator\">&lt;-</span> tags<span class=\"token operator\">$</span>div<span class=\"token punctuation\">(</span>\n        id <span class=\"token operator\">=</span> id<span class=\"token punctuation\">,</span>\n        class <span class=\"token operator\">=</span> <span class=\"token string\">\"visually-hidden loading-ui loading-dots\"</span><span class=\"token punctuation\">,</span>\n        `aria<span class=\"token operator\">-</span>hidden` <span class=\"token operator\">=</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">$</span>div<span class=\"token punctuation\">(</span>\n            class <span class=\"token operator\">=</span> <span class=\"token string\">\"dots-container\"</span><span class=\"token punctuation\">,</span>\n            tags<span class=\"token operator\">$</span>span<span class=\"token punctuation\">(</span>class <span class=\"token operator\">=</span> <span class=\"token string\">\"dots\"</span><span class=\"token punctuation\">,</span> id <span class=\"token operator\">=</span> <span class=\"token string\">\"dot1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            tags<span class=\"token operator\">$</span>span<span class=\"token punctuation\">(</span>class <span class=\"token operator\">=</span> <span class=\"token string\">\"dots\"</span><span class=\"token punctuation\">,</span> id <span class=\"token operator\">=</span> <span class=\"token string\">\"dot2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            tags<span class=\"token operator\">$</span>span<span class=\"token punctuation\">(</span>class <span class=\"token operator\">=</span> <span class=\"token string\">\"dots\"</span><span class=\"token punctuation\">,</span> id <span class=\"token operator\">=</span> <span class=\"token string\">\"dot3\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># if a message is specified, then replace dots</span>\n    <span class=\"token comment\"># and adjust classes</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        el<span class=\"token operator\">$</span>attribs<span class=\"token operator\">$</span>class <span class=\"token operator\">&lt;-</span> <span class=\"token string\">\"loading-ui loading-text\"</span>\n        el<span class=\"token operator\">$</span>children <span class=\"token operator\">&lt;-</span> tags<span class=\"token operator\">$</span>p<span class=\"token punctuation\">(</span>\n            class <span class=\"token operator\">=</span> <span class=\"token string\">\"loading-message\"</span><span class=\"token punctuation\">,</span>\n            as.character<span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\"># return</span>\n    return<span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next, let's create a parent function that returns the loading element and leaflet output. This function will call the child function and return the loader and the leaflet output in a container.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token comment\">#' loader</span>\nloading_message <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token ellipsis\">...</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> text <span class=\"token operator\">=</span> <span class=\"token keyword\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    tags<span class=\"token operator\">$</span>div<span class=\"token punctuation\">(</span>\n        class <span class=\"token operator\">=</span> <span class=\"token string\">\"loading-container\"</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">$</span>span<span class=\"token punctuation\">(</span>\n            class <span class=\"token operator\">=</span> <span class=\"token string\">\"visually-hidden\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"loading\"</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        loading_elem<span class=\"token punctuation\">(</span>id <span class=\"token operator\">=</span> id<span class=\"token punctuation\">,</span> text <span class=\"token operator\">=</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token ellipsis\">...</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I've added a loading message for better accessibility support. This won't be displayed in the app nor will it interfere with the layout (I will update this element in the future after I do some more research on the best practices for loading messages).</p>\n<p>When using the function, the leaflet output will be passed into the ellipses (<code>...</code>). Back in the <code>app.R</code> file, load the <code>leaflet_loader.R</code> and call the function like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\"><span class=\"token comment\"># component</span>\nsource<span class=\"token punctuation\">(</span><span class=\"token string\">\"leaflet_loader.R\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># ui</span>\nui <span class=\"token operator\">&lt;-</span> tagList<span class=\"token punctuation\">(</span>\n    tags<span class=\"token operator\">$</span>head<span class=\"token punctuation\">(</span>\n        tags<span class=\"token operator\">$</span>link<span class=\"token punctuation\">(</span>\n            rel <span class=\"token operator\">=</span> <span class=\"token string\">\"stylesheet\"</span><span class=\"token punctuation\">,</span>\n            href <span class=\"token operator\">=</span> <span class=\"token string\">\"styles.css\"</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n    tags<span class=\"token operator\">$</span>main<span class=\"token punctuation\">(</span>\n        tags<span class=\"token operator\">$</span>h2<span class=\"token punctuation\">(</span><span class=\"token string\">\"Map Output\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">$</span>button<span class=\"token punctuation\">(</span>\n            id <span class=\"token operator\">=</span> <span class=\"token string\">\"plotbutton\"</span><span class=\"token punctuation\">,</span>\n            class <span class=\"token operator\">=</span> <span class=\"token string\">\"action-button shiny-bound-input\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"Add Markers\"</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token comment\"># loading ui</span>\n        loading_message<span class=\"token punctuation\">(</span>\n            id <span class=\"token operator\">=</span> <span class=\"token string\">\"leafletBusy\"</span><span class=\"token punctuation\">,</span>\n            leafletOutput<span class=\"token punctuation\">(</span><span class=\"token string\">\"map\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>If you want to display a text-based loading UI, then pass a message using the <code>text</code> argument. You may use any ID that you like.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">loading_message<span class=\"token punctuation\">(</span>id <span class=\"token operator\">=</span> <span class=\"token string\">\"myID\"</span><span class=\"token punctuation\">,</span> text <span class=\"token operator\">=</span> <span class=\"token string\">\"Map is Loading\"</span><span class=\"token punctuation\">,</span> leafletOutput<span class=\"token punctuation\">(</span><span class=\"token string\">\"map\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<span id=\"work-ui-css\" />\n<h3>Styling the loading UI</h3>\n<p>Now I will focus on writting the css. I won't cover everything in the css file as this post can get quite long. I will focus on the elements that will help you create your own loaders.</p>\n<p>The most important part is the class that hides and shows the loading element. The class <code>.visually-hidden</code> is used to reveal the loading UI during the rendering and updating of the leaflet map. This class is the closest to hiding the loading element without removing it from the page. Modifying the display properties of an element can disrupt the document structure as elements are removed from the page. This may be very disruptive for the user. Instead, the following class reduces the size to the smallest possible size.</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token comment\">/* class to visually hide loading screens */</span>\n<span class=\"token selector\">.visually-hidden</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> absolute<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">clip</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rect</span><span class=\"token punctuation\">(</span>0<span class=\"token punctuation\">,</span> 0<span class=\"token punctuation\">,</span> 0<span class=\"token punctuation\">,</span> 0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token property\">clip</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rect</span><span class=\"token punctuation\">(</span>0 0 0 0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 1px<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 1px<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">overflow</span><span class=\"token punctuation\">:</span> hidden<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">white-space</span><span class=\"token punctuation\">:</span> nowrap<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To display the loading UI over the leaflet map, use relative positioning on the loading container. For the loading ui, I used asbolute positioning and set the z-index to an arbitrary value. This will place the loading UI on top of the leaflet output.</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token comment\">/* styling for loading container */</span>\n<span class=\"token selector\">.loading-container</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> relative<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/* loading ui  */</span>\n<span class=\"token selector\">.loading-container .loading-ui</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> flex<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">justify-content</span><span class=\"token punctuation\">:</span> center<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">align-items</span><span class=\"token punctuation\">:</span> center<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> absolute<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 100%<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 100%<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> #f6f6f6<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">text-align</span><span class=\"token punctuation\">:</span> center<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">z-index</span><span class=\"token punctuation\">:</span> 9999<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<span id=\"work-ui-js\" />\n<h3>Writing javascript to control the loading UI</h3>\n<p>In this section, we will write the javascript to show/hide the loading screen during the intitial rendering of the leaflet map and when the button is clicked.</p>\n<p>In early tests, I attempted to show and hide the loading element using <a href=\"https://shiny.rstudio.com/articles/communicating-with-js.html\">custom message handlers</a>. It worked, but the results were inconsistent and it was very buggy. After searching forums for leaflet approaches and consulting the documentation, I realized that if I could \"hook\" into leaflet <a href=\"https://leafletjs.com/reference-1.6.0.html#domevent\">DOMevents</a> than it would be possible to control the loader from the htmlwidget. This was not as straightfoward as I originally thought. Writing functions in a separate js file and loading it into our app isn't possible due to the structure of htmlwidgets. Using the <code>onRender</code> function in the <a href=\"https://cran.r-project.org/package=htmlwidgets\">htmlwidgets</a>, you can pass additional js code down to the htmlwidget.</p>\n<p>In the <code>renderLeaflet</code> function, we will pipe the leaflet object into the <code>onRender</code> function.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">leaflet<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span>\n    addTiles<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span>\n    setView<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">93.65</span><span class=\"token punctuation\">,</span> <span class=\"token number\">42.0285</span><span class=\"token punctuation\">,</span> zoom <span class=\"token operator\">=</span> <span class=\"token number\">17</span><span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span>\n    addPopups<span class=\"token punctuation\">(</span>\n        lng <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">93.65</span><span class=\"token punctuation\">,</span>\n        lat <span class=\"token operator\">=</span> <span class=\"token number\">42.0285</span><span class=\"token punctuation\">,</span>\n        popup <span class=\"token operator\">=</span> <span class=\"token string\">\"Here is the &lt;b>Department of Statistics&lt;/b>, ISU\"</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span>\n    onRender<span class=\"token punctuation\">(</span>.<span class=\"token punctuation\">,</span> \"\n        <span class=\"token operator\">/</span><span class=\"token operator\">/</span> js code will go here\n    \"<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The first thing we will do, is define a new function. According to the documentation, the js code should start with <code>function(el, x)</code>. (In the following code blocks, I'll only focus on the javascript. See the <code>app.R</code> file for the complete code.)</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// inside the onRender</span>\n<span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">el<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Inside the function, start off by selecting the primary elements: the leaflet map, the loading element, and the action button.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// inside the onRender</span>\n<span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">el<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> m <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> elem <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'leafletBusy'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> b <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'plotbutton'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>During the initial render of the map, we want the show to loader and then hide it when the map is complete. This can be done by using the leaflet event <code>whenReady</code> and attaching it to the map element <code>m</code>. The <code>whenReady</code> event will run fairly quickly (I think this triggers when base elements are generated), so I'm using <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout\">setTimeout</a> to delay the hiding of the element for 3000 milliseconds (adjust this value accordingly to fit your needs).</p>\n<p>I'm using <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Element/classList\">classList</a> to <code>add</code> and <code>remove</code> the <code>.visually-hidden</code> class from the loader.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// inside the onRender</span>\n<span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">el<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> m <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> elem <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'leafletBusy'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> b <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'plotbutton'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// when map is rendered, display loading</span>\n    <span class=\"token comment\">// adjust delay as needed</span>\n    m<span class=\"token punctuation\">.</span><span class=\"token function\">whenReady</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        elem<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token string\">'visually-hidden'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            elem<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'visually-hidden'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Using this same concept, we can apply it to the button event. The structure is quite different than the ready event as we want to show the loader when the button is clicked and then hide it once all new map elements are rendered. Let's start with the basics: define an event that shows the loader as soon as the button is clicked.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// inside the onRender</span>\n<span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">el<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> m <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> elem <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'leafletBusy'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> b <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'plotbutton'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// when map is rendered, display loading</span>\n    <span class=\"token comment\">// adjust delay as needed</span>\n    m<span class=\"token punctuation\">.</span><span class=\"token function\">whenReady</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        elem<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token string\">'visually-hidden'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            elem<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'visually-hidden'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// click event</span>\n    b<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token comment\">// show loading element</span>\n        elem<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token string\">'visually-hidden'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The leaflet event <code>layeradd</code> is useful for running an event during an \"update\", but something else is needed to run additional functions when an event is completed. In this case, we will use a <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise\">promise</a> to hide the loader once the layer is updated. Within the <code>layeradd</code> event, we will <code>resolve</code> the event after the event is finished. You can also set a delay to extend this action. Here's the basic structure for the layer event.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">m<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'layeradd'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// do something here</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The basic structure of a promise looks like this. (You can assign the promise to a variable and then attach other <code>then</code>-s; see previous link for further information).</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token comment\">// do something</span>\n\n    <span class=\"token comment\">// resolve + pass data if required</span>\n    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'done'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// do something on resolve</span>\n    \n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// if there is an error,</span>\n    <span class=\"token comment\">// throw</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Inside the promise, we will write the <code>layeradd</code> event and add a timeout before the resolve. In the <code>then</code>, we will hide the loader. If there is an error in the promise, the <code>catch</code> will log it to the console. Here's the promise.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token comment\">// leaflet event: layeradd</span>\n    m<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'layeradd'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"adding element\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// resolve after a few seconds to ensure all</span>\n        <span class=\"token comment\">// elements rendered (adjust as needed)</span>\n        <span class=\"token comment\">// time is in milliseconds</span>\n        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'done'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token comment\">// resolve: hide loading screen</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'done'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    elem<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'visually-hidden'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token comment\">// throw errors</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Here is the entire <code>onRender</code> function.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// inside the onRender</span>\n<span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">el<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> m <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> elem <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'leafletBusy'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> b <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'plotbutton'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// when map is rendered, display loading</span>\n    <span class=\"token comment\">// adjust delay as needed</span>\n    m<span class=\"token punctuation\">.</span><span class=\"token function\">whenReady</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        elem<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token string\">'visually-hidden'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            elem<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'visually-hidden'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// click event</span>\n    b<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        \n        <span class=\"token comment\">// show loading element</span>\n        elem<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token string\">'visually-hidden'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// promise</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n            <span class=\"token comment\">// leaflet event: layeradd</span>\n            m<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'layeradd'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n                <span class=\"token comment\">// this log is for demonstration purposes only</span>\n                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"adding element\"</span><span class=\"token punctuation\">)</span>\n\n                <span class=\"token comment\">// resolve after a few seconds to ensure all</span>\n                <span class=\"token comment\">// elements rendered (adjust as needed)</span>\n                <span class=\"token comment\">// time is in milliseconds</span>\n                <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'done'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n            <span class=\"token comment\">// resolve: hide loading screen</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'done'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            elem<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'visually-hidden'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n            <span class=\"token comment\">// throw errors</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>That is it! See the <code>app.R</code> file for the complete code. Take a look at the css file for all of the styles used in the app. Don't forget to adjust the timeouts as needed.</p>\n<span id=\"know\" />\n<h2>What do I need to know before I integrate this into my app?</h2>\n<p>This example works, but it requires a bit a hardcoding. I would recommend wrapping generating the on render script using a function. This would allow you to pass name the button ID, define the css class that hides the loading element, and to adjust delays. I will update the app when in the near future. Stay tuned!</p>\n<p>Some of the timeouts are bit quick. You may want to extend them a bit to smooth out the events. You may also want to add some css <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/transition\">transitions</a> to smooth out the hiding/showing of the loader.</p>\n<span id=\"run\" />\n<h2>How do I run the example?</h2>\n<p>The code for this app can be found on Github: <a href=\"https://github.com/davidruvolo51/shinyAppTutorials/tree/master/leaflet-loading-screens\">shinyAppTutorials/leaflet-loading-screens</a>. Alternatively, you can run the app directly from the R console.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">install.packages<span class=\"token punctuation\">(</span><span class=\"token string\">\"shiny\"</span><span class=\"token punctuation\">)</span>\nshiny<span class=\"token operator\">::</span>runGithub<span class=\"token punctuation\">(</span>repo<span class=\"token operator\">=</span><span class=\"token string\">\"shinyAppTutorials\"</span><span class=\"token punctuation\">,</span> username<span class=\"token operator\">=</span><span class=\"token string\">\"davidruvolo51\"</span><span class=\"token punctuation\">,</span> subdir<span class=\"token operator\">=</span><span class=\"token string\">\"leaflet-loading-screens\"</span><span class=\"token punctuation\">)</span></code></pre></div>","frontmatter":{"title":"Leaflet Busy Element","subtitle":"Create a custom loading element for leaflet maps","abstract":"The leaflet package in R is great package for creating interactive maps in shiny. However, if you are using larger datasets or running a lot of server-side jobs, it may take some time for the leaflet map to render and update. Displaying progress indicators can improve the user experience by reassuring the user when something is happening and how long it might last.","date":"2020-04-02","updated":"2020-04-23","keywords":["leaflet","htmlwidgets"]},"fields":{"readingTime":{"minutes":13.48}}}},"pageContext":{"slug":"/tutorials/leaflet-loading-screens/"}}}